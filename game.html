<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Quack Whack | Workshop Aframe Game</title>
    <script src="https://aframe.io/releases/0.8.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/donmccurdy/aframe-physics-system/v3.0.2/dist/aframe-physics-system.min.js"></script>
    <script src="https://rawgit.com/feiss/aframe-environment-component/master/dist/aframe-environment-component.min.js"></script>

</head>

<body>
    <!-- <a-scene stats sound="src: url(sfx/cartoonish-loop.wav); loop:true; autoplay:true; volume:0.3;"> -->
    <a-scene>
        <!-- assets -->
        <a-assets>
            <img id="wood" src="img/wood.jpg">
            <a-asset-item id="duck" src="models/duck/scene.gltf"></a-asset-item>
            <!-- bomba -->
            <a-asset-item id="bomb" src="models/bomb/scene.gltf">
            </a-asset-item>
            <a-asset-item id="pan" src="models/pan/scene.gltf"></a-asset-item>

        </a-assets>

        <!-- light -->
        <a-entity light="type: directional; color: #ffffff; intensity: 0.5; castShadow:true;" position="10 0 10">
        </a-entity>
        <a-entity light="type: hemisphere; color: #ffff00; groundColor: green; intensity: 0.5;">
        </a-entity>

        <!-- kamera -->
        <a-camera look-controls position="0 2.5 2">
            <a-cylinder position="0 0 -6" id="weapon" radius="0.8" height="0.05" opacity="0" rotation="10 0 10" static-body>
                <a-entity position="0 0 0" scale="0.12 0.12 0.12" rotation="0.3 -86 0.06" shadow="cast:true;" gltf-model="#pan"></a-entity>
            </a-cylinder>
        </a-camera>

        <!-- kaczka -->
        <a-sphere id="ball" position="0 0.5 -4" dynamic-body radius="0.3" opacity="0">
            <a-entity id="duck-model" position="0 0.3 0" scale="0.003 0.003 0.003" gltf-model="#duck" shadow="cast:true;receive:false;"
                sound="src: url(sfx/quack.wav); autoplay: false; loop: false;">
            </a-entity>
            <a-entity id="bomb-model" position="0 -0.2 0" scale="0.3 0.3 0.3" gltf-model="#bomb" sound="src: url(sfx/bomb.mp3); autoplay: false; loop: false;"
                shadow="cast:true;receive:false;">
            </a-entity>
        </a-sphere>

        <!-- enviroment -->
        <a-entity environment="preset: forest; ground: canyon; groundTexture: walkernoise;"></a-entity>

        <!-- box -->
        <a-box position="0 0.5 -4" src="#wood" width="8" height="1.25" depth="1">
            <a-text id="score" font="https://cdn.aframe.io/fonts/mozillavr.fnt" value="Score: 0" position="-0.4 0.3 0.6" color="yellow">
            </a-text>
        </a-box>
        <a-entity position="-3 1.13 -4" rotation="-90 0 0" geometry="primitive: circle; radius: 0.45" material="color: black;"></a-entity>
        <a-entity position="0 1.13 -4" rotation="-90 0 0" geometry="primitive: circle; radius: 0.45" material="color: black;"></a-entity>
        <a-entity position="3 1.13 -4" rotation="-90 0 0" geometry="primitive: circle; radius: 0.45" material="color: black;"></a-entity>

        <a-box position="-4.5 0.5 -2.5" src="#wood" width="1" height="1.25" depth="4"></a-box>
        <a-entity position="-4.5 1.13 -2" rotation="-90 0 0" geometry="primitive: circle; radius: 0.3" material="color: black;"></a-entity>

        <a-box position="4.5 0.5 -2.5" src="#wood" width="1" height="1.25" depth="4"></a-box>
        <a-entity position="4.5 1.13 -2" rotation="-90 0 0" geometry="primitive: circle; radius: 0.3" material="color: black;"></a-entity>

    </a-scene>

    <script>
        const qS = (selector) => document.querySelector(selector);
        let hit = false;
        let resetId = 0;
        let duckPos = [[-4.5, 1, -2], [-3, 1, -4], [0, 1, -4], [3, 1, -4], [4.5, 1, -2]];
        let score = 0;
        let showDuck = true;

        const resetBall = () => {
            clearTimeout(resetId);
            let randPos = Math.floor(Math.random() * Math.floor(5));
            qS("#ball").body.position.set(duckPos[randPos][0], duckPos[randPos][1], duckPos[randPos][2]);
            qS("#ball").body.velocity.set(0, 8, 0);
            qS("#ball").body.angularVelocity.set(0, 0, 0);
            hit = false;
            showDuck = (Math.floor(Math.random() * 4) !== 0)
            qS("#duck-model").setAttribute('visible', showDuck);
            qS("#bomb-model").setAttribute('visible', !showDuck);
            resetId = setTimeout(resetBall, 4000);
        }

        qS("#weapon").addEventListener('collide', (e) => {
            let ball = qS("#ball");
            if (e.detail.body.id === ball.body.id && !hit) {
                hit = true;
                if (showDuck) {
                    score = score + 1;
                    qS("#duck-model").components.sound.playSound();
                } else {
                    score = score - 5;
                    qS("#bomb-model").components.sound.playSound();
                }
                qS("#score").setAttribute('text', 'value', 'Score: ' + score);
                qS("#ball").body.position.set(0, 0.5, -4);
                clearTimeout(resetId);
                resetId = setTimeout(resetBall, 4000);
            }
        });

        setTimeout(resetBall, 4000);
    </script>

    <script id="__bs_script__">//<![CDATA[
        document.write("<script async src='http://HOST:3000/browser-sync/browser-sync-client.js?v=2.23.6'><\/script>".replace("HOST", location.hostname));
    //]]></script>
</body>

</html>